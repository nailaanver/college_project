{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
:root {
    /* REVERTED: Original Navy/Grey Palette for Background and Header */
    --navy-dark: #0b1c39;
    --navy-grey: rgba(11, 28, 57, 0.85);
    
    /* NEW: Beige Palette for the Cards only */
    --beige-card: rgba(245, 245, 220, 0.95); /* Creamy beige */
    --beige-dark-text: #2c261e;              /* Deep coffee text for readability */
    --gold: #c5a021;                         /* Professional gold */
    --glass-border: rgba(197, 160, 33, 0.3);
}

body {
    font-family: 'Poppins', sans-serif;
    /* REVERTED: Original Dark Background */
    background: linear-gradient(var(--navy-grey), var(--navy-grey)),
                url("{% static 'images/campus.jpg' %}") center/cover no-repeat fixed;
    margin: 0;
    padding-bottom: 50px;
    color: #ffffff; /* Default body text remains white for contrast against dark bg */
}

/* --- Original Navy Header --- */
.dashboard-header {
    background: var(--navy-dark);
    backdrop-filter: blur(15px);
    padding: 15px 5%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--glass-border);
    position: sticky;
    top: 0;
    z-index: 1000;
}

.header-left h2 { margin: 0; font-size: 20px; font-weight: 700; color: #ffffff; }
.header-left span { color: var(--gold); font-size: 11px; letter-spacing: 2px; font-weight: 600; }

.nav-actions { display: flex; align-items: center; gap: 25px; }
.bell-link { position: relative; color: #ffffff; font-size: 18px; }
.notification-badge {
    position: absolute; top: -8px; right: -10px;
    background: #ff4d4d; color: white; border-radius: 50%;
    padding: 2px 6px; font-size: 10px; font-weight: bold;
}

.logout-btn {
    background: var(--gold); color: var(--navy-dark);
    padding: 8px 18px; text-decoration: none; border-radius: 8px;
    font-weight: 700; font-size: 12px; transition: 0.3s;
}

/* --- Beige Dashboard Cards --- */
.main-container {
    max-width: 1200px;
    margin: 30px auto;
    padding: 0 20px;
    display: flex;
    flex-direction: column;
    gap: 25px;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px;
}

.glass-card {
    background: var(--beige-card); /* Beige background for cards */
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 25px;
    transition: transform 0.3s ease;
    color: var(--beige-dark-text); /* Dark text inside beige cards */
    box-shadow: 0 15px 35px rgba(0,0,0,0.2);
}
.glass-card:hover { transform: translateY(-5px); }

.card-title {
    margin-top: 0; color: var(--gold); font-size: 17px;
    margin-bottom: 20px; display: flex; align-items: center; gap: 10px;
    font-weight: 800; text-transform: uppercase;
}

/* --- Inside Card Styling --- */
.student-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; }
.info-item label { display: block; font-size: 10px; color: var(--gold); font-weight: 700; }
.info-item p { margin: 5px 0 0; font-size: 15px; font-weight: 600; color: var(--beige-dark-text); }

.attendance-pill {
    background: rgba(197, 160, 33, 0.15);
    border: 1px solid var(--gold); color: var(--gold);
    padding: 2px 10px; border-radius: 15px; font-size: 13px; font-weight: 700;
}

.history-btn {
    background: var(--navy-dark); color: #fff;
    padding: 10px 15px; border-radius: 8px; text-decoration: none;
    font-size: 12px; font-weight: 600; transition: 0.3s;
}
.history-btn:hover { background: var(--gold); color: var(--navy-dark); }

/* --- Tables (Inside Beige Cards) --- */
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th { text-align: left; padding: 12px; color: var(--gold); font-size: 11px; border-bottom: 2px solid rgba(0,0,0,0.05); }
td { padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.03); font-size: 13px; color: var(--beige-dark-text); }

.pay-btn {
    background: var(--gold); color: #fff; border: none;
    padding: 8px 15px; border-radius: 6px; font-weight: 800;
    cursor: pointer; transition: 0.3s; font-size: 11px;
}
.pay-btn:hover { background: var(--navy-dark); transform: scale(1.05); }

.status-paid { color: #2d6a4f; font-weight: 700; font-size: 12px; }

@media (max-width: 992px) { .dashboard-grid { grid-template-columns: 1fr; } }
</style>

<div class="dashboard-header">
    <div class="header-left">
        <h2>{{ parent_user.get_full_name|default:parent_user.username }}</h2>
        <span>PARENT CONTROL DASHBOARD</span>
    </div>
    <div class="nav-actions">
        <a href="{% url 'parent_notification_list' %}" class="bell-link">
            <i class="fa-solid fa-bell"></i>
            {% if unread_notification_count > 0 %}<span class="notification-badge">{{ unread_notification_count }}</span>{% endif %}
        </a>
        <a href="{% url 'parent_logout' %}" class="logout-btn"><i class="fas fa-power-off"></i> LOGOUT</a>
    </div>
</div>

<div class="main-container">
    <div class="glass-card">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
            <div class="student-info-grid" style="flex-grow: 1;">
                <div class="info-item"><label>Student Name</label><p>{{ student.first_name }} {{ student.last_name }}</p></div>
                <div class="info-item"><label>Reg Number</label><p>#{{ student.register_number }}</p></div>
                <div class="info-item"><label>Semester</label><p>{{ student.course }} | Sem {{ student.semester }}</p></div>
                <div class="info-item"><label>Attendance</label><p><span class="attendance-pill">{{ attendance_percentage }}%</span></p></div>
            </div>
            {% if student.semester > 1 %}
            <a href="{% url 'parent_previous_semester' student.semester|add:'-1' %}" class="history-btn">View Sem {{ student.semester|add:'-1' }}</a>
            {% endif %}
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="glass-card">
            <h3 class="card-title"><i class="fas fa-wallet"></i> Pending Dues</h3>
            <table>
                <thead><tr><th>Fee Type</th><th>Amount</th><th>Action</th></tr></thead>
                <tbody>
                    {% for fee in student_fees %}
                    <tr>
                        <td>{{ fee.fee_type }}</td>
                        <td style="font-weight: 700; color: #b00020;">₹ {{ fee.amount }}</td>
                        <td><button type="button" class="pay-btn" data-fee-url="{% url 'api_create_payment' fee.id %}">PAY NOW</button></td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" style="text-align: center; opacity: 0.5;">No pending dues.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="glass-card">
            <h3 class="card-title"><i class="fas fa-chart-line"></i> Internal Marks</h3>
            <table>
                <thead><tr><th>Subject</th><th>T1</th><th>T2</th><th>Total</th></tr></thead>
                <tbody>
                    {% for mark in internal_marks %}
                    <tr>
                        <td>{{ mark.subject.name }}</td><td>{{ mark.test1 }}</td><td>{{ mark.test2 }}</td>
                        <td style="color: var(--gold); font-weight: 800;">{{ mark.total_internal }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" style="text-align: center; opacity: 0.5;">No marks recorded.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="glass-card">
        <h3 class="card-title"><i class="fas fa-receipt"></i> Transaction History</h3>
        <div style="overflow-x: auto;">
            <table>
                <thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Status</th></tr></thead>
                <tbody>
                    {% for fee in paid_fees %}
                    <tr>
                        <td>{{ fee.paid_on|date:"d M Y" }}</td>
                        <td>{{ fee.fee_type }}</td>
                        <td>₹ {{ fee.amount }}</td>
                        <td><span class="status-paid"><i class="fas fa-check-circle"></i> SUCCESS</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<meta name="csrf-token" content="{{ csrf_token }}">

<script>
document.addEventListener("DOMContentLoaded", function () {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    document.querySelectorAll(".pay-btn").forEach(btn => {
        btn.addEventListener("click", function () {
            const apiUrl = this.dataset.feeUrl;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            this.disabled = true;
            fetch(apiUrl, {
                method: "POST",
                credentials: "same-origin",
                headers: { "X-CSRFToken": csrfToken, "Accept": "application/json" }
            })
            .then(res => res.json())
            .then(data => {
                if (data.approval_url) window.location.href = data.approval_url;
                else { alert("Payment Error"); this.innerHTML = "PAY NOW"; this.disabled = false; }
            });
        });
    });
});
</script>
{% endblock %}