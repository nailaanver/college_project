{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
:root {
    --navy-dark: #0b1c39;
    --navy: #142850;
    --gold: #f3c623;
    --white: #ffffff;
    --bg-light: #f4f6f8;
}
body { font-family: Arial, sans-serif; background-color: var(--bg-light); margin: 0; padding: 0; }
.header { background-color: var(--navy); color: var(--white); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--gold); }
.header h2 { margin: 0; font-weight: 600; }
.logout { color: var(--navy-dark); background: var(--gold); padding: 8px 16px; text-decoration: none; border-radius: 20px; font-size: 14px; font-weight: 600; }
.container { max-width: 1000px; margin: 30px auto; padding: 0 20px; }
.card { background: var(--white); padding: 20px; margin-bottom: 20px; border-radius: 10px; border-left: 5px solid var(--navy); box-shadow: 0 6px 14px rgba(0,0,0,0.08); }
.card h3 { margin-top: 0; color: var(--navy); }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th { background-color: var(--navy-dark); color: var(--white); padding: 10px; }
td { padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: center; }
.action-btn { padding: 10px 20px; background: var(--navy); color: var(--white); border: none; border-radius: 30px; font-size: 14px; font-weight: 600; cursor: pointer; }
.action-btn:hover { background: var(--gold); }
.present { color: #198754; font-weight: bold; }
.absent  { color: #dc3545; font-weight: bold; }
.late    { color: #fd7e14; font-weight: bold; }
</style>

<div class="header">
    <h2>Welcome {{ parent_user.get_full_name|default:parent_user.username }} ðŸ‘‹</h2>
    <a href="{% url 'parent_logout' %}" class="logout">Logout</a>
</div>

<div class="container">
    <!-- Student Info -->
    <div class="card">
        <h3>Student Details</h3>
        <p><strong>Name:</strong> {{ student.first_name }} {{ student.last_name }}</p>
        <p><strong>Register Number:</strong> {{ student.register_number }}</p>
        <p><strong>Course:</strong> {{ student.course }}</p>
        <p><strong>Semester:</strong> {{ student.get_semester_display }}</p>
        <p><strong>Attendance Today:</strong> {{ attendance_percentage }}%</p>
    </div>

    <!-- Pending Fees -->
    <div class="card">
        <h3>Pending Fees</h3>
        <table>
            <tr>
                <th>Fee Type</th>
                <th>Amount</th>
                <th>Due Date</th>
                <th>Action</th>
            </tr>
            {% for fee in student_fees %}
            <tr>
                <td>{{ fee.fee_type }}</td>
                <td>â‚¹ {{ fee.amount }}</td>
                <td>{{ fee.due_date }}</td>
                <td>
                    <!-- Store full URL in data attribute -->
                    <button type="button" class="action-btn pay-btn" data-fee-url="{% url 'api_create_payment' fee.id %}">
                        Pay Now
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4">No pending fees ðŸŽ‰</td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <!-- Paid Fees -->
<div class="card">
    <h3>Paid Fees</h3>
    <table>
        <tr>
            <th>Fee Type</th>
            <th>Amount</th>
            <th>Paid On</th>
            <th>PayPal Order ID</th>
            <th>Status</th>
        </tr>

        {% for fee in paid_fees %}
        <tr>
            <td>{{ fee.fee_type }}</td>
            <td>â‚¹ {{ fee.amount }}</td>
            <td>{{ fee.paid_on|date:"d M Y, h:i A" }}</td>
            <td>{{ fee.paypal_order_id }}</td>
            <td class="present">Paid</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="5">No fees paid yet</td>
        </tr>
        {% endfor %}
    </table>
</div>

</div>

<!-- CSRF Meta -->
<meta name="csrf-token" content="{{ csrf_token }}">

<script>
document.addEventListener("DOMContentLoaded", function () {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    document.querySelectorAll(".pay-btn").forEach(btn => {
        btn.addEventListener("click", function () {
            const apiUrl = this.dataset.feeUrl;

            fetch(apiUrl, {
                method: "POST",
                credentials: "same-origin",
                headers: {
                    "X-CSRFToken": csrfToken,
                    "Accept": "application/json"
                }
            })
            .then(res => {
                if (!res.ok) throw new Error("Network or authorization error");
                return res.json();
            })
            .then(data => {
                if (data.approval_url) {
                    window.location.href = data.approval_url;
                } else {
                    alert("Payment error: " + (data.error || "Unknown error"));
                    console.log(data.error);
                }
            })
            .catch(err => {
                console.error("Fetch error:", err);
                alert("Payment failed. Try again.");
            });
        });
    });
});
</script>

{% endblock %}
