{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
:root {
    --navy-dark: #0b1c39;
    --gold: #f3c623;
    --white: #ffffff;
    --glass-bg: rgba(255, 255, 255, 0.1); /* Translucent White */
    --glass-border: rgba(255, 255, 255, 0.2);
    --glass-text: #ffffff;
}

body {
    font-family: 'Poppins', sans-serif;
    /* Background image with dark overlay to make text pop */
    background: linear-gradient(rgba(11, 28, 57, 0.8), rgba(11, 28, 57, 0.8)),
                url("{% static 'images/campus.jpg' %}") center/cover no-repeat fixed;
    margin: 0;
    padding-bottom: 50px;
    color: var(--white);
}

/* --- Header Section --- */
.dashboard-header {
    background: rgba(11, 28, 57, 0.6);
    backdrop-filter: blur(15px);
    padding: 20px 5%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--glass-border);
}

.header-left h2 {
    margin: 0;
    font-size: 24px;
    font-weight: 700;
}

.header-left span {
    color: var(--gold);
    font-size: 12px;
    letter-spacing: 2px;
    font-weight: 600;
}

.logout-btn {
    background: var(--gold);
    color: var(--navy-dark);
    padding: 10px 24px;
    text-decoration: none;
    border-radius: 12px;
    font-weight: 800;
    font-size: 13px;
    transition: 0.3s;
}

.logout-btn:hover {
    background: var(--white);
    transform: scale(1.05);
}

/* --- Layout Container --- */
.main-container {
    max-width: 1100px;
    margin: 40px auto;
    padding: 0 20px;
}

/* --- Glass Card Styling --- */
.glass-card {
    background: var(--glass-bg);
    backdrop-filter: blur(20px); /* Frosted Glass Effect */
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
}

.glass-card h3 {
    margin-top: 0;
    color: var(--gold);
    font-size: 20px;
    letter-spacing: 1px;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 12px;
}

/* --- Student Info Grid --- */
.student-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 25px;
}

.info-item label {
    display: block;
    font-size: 11px;
    color: var(--gold);
    text-transform: uppercase;
    font-weight: 700;
    opacity: 0.8;
}

.info-item p {
    margin: 5px 0;
    font-size: 17px;
    color: var(--white);
    font-weight: 500;
}

.attendance-pill {
    background: rgba(243, 198, 35, 0.2);
    border: 1px solid var(--gold);
    color: var(--gold);
    padding: 4px 12px;
    border-radius: 8px;
    font-weight: 700;
}

/* --- Glass Tables --- */
.table-container {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    text-align: left;
    padding: 15px;
    color: var(--gold);
    font-size: 12px;
    text-transform: uppercase;
    border-bottom: 1px solid var(--glass-border);
}

td {
    padding: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    font-size: 14px;
    color: var(--white);
}

tr:hover td {
    background: rgba(255, 255, 255, 0.05);
}

/* --- Buttons --- */
.pay-btn {
    background: var(--gold);
    color: var(--navy-dark);
    border: none;
    padding: 8px 16px;
    border-radius: 10px;
    font-weight: 800;
    cursor: pointer;
    transition: 0.3s ease;
    text-transform: uppercase;
    font-size: 12px;
}

.pay-btn:hover {
    background: var(--white);
    box-shadow: 0 0 15px rgba(243, 198, 35, 0.4);
}

/* --- Marks Highlight --- */
.total-mark {
    color: var(--gold);
    font-size: 16px;
    font-weight: 700;
}

/* Responsive */
@media (max-width: 768px) {
    .dashboard-header { flex-direction: column; text-align: center; gap: 15px; }
}
</style>

<div class="dashboard-header">
    <div class="header-left">
        <h2>{{ parent_user.get_full_name|default:parent_user.username }}</h2>
        <span>PARENT CONTROL DASHBOARD</span>
    </div>
    <a href="{% url 'parent_logout' %}" class="logout-btn">
        <i class="fas fa-power-off"></i> LOGOUT
    </a>
</div>

<div class="main-container">
    
    <div class="glass-card">
        <h3><i class="fas fa-id-card"></i> Student Overview</h3>
        <div class="student-info-grid">
            <div class="info-item">
                <label>Full Name</label>
                <p>{{ student.first_name }} {{ student.last_name }}</p>
            </div>
            <div class="info-item">
                <label>Reg Number</label>
                <p>#{{ student.register_number }}</p>
            </div>
            <div class="info-item">
                <label>Academic Year</label>
                <p>{{ student.course }} | Sem {{ student.semester }}</p>
            </div>
            <div class="info-item">
                <label>Attendance</label>
                <p><span class="attendance-pill">{{ attendance_percentage }}%</span></p>
            </div>
        </div>
    </div>

    <div class="glass-card">
        <h3><i class="fas fa-wallet"></i> Pending Dues</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Fee Particulars</th>
                        <th>Amount</th>
                        <th>Due Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for fee in student_fees %}
                    <tr>
                        <td>{{ fee.fee_type }}</td>
                        <td>₹ {{ fee.amount }}</td>
                        <td>{{ fee.due_date }}</td>
                        <td>
                            <button type="button" class="pay-btn" data-fee-url="{% url 'api_create_payment' fee.id %}">
                                Pay via PayPal
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" style="text-align: center; opacity: 0.6; padding: 30px;">
                            No pending payments found.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="glass-card">
        <h3><i class="fas fa-graduation-cap"></i> Internal Assessment</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>T1</th>
                        <th>T2</th>
                        <th>ASM</th>
                        <th>ATT</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mark in internal_marks %}
                    <tr>
                        <td>{{ mark.subject.name }}</td>
                        <td>{{ mark.test1 }}</td>
                        <td>{{ mark.test2 }}</td>
                        <td>{{ mark.assignment }}</td>
                        <td>{{ mark.attendance_mark }}</td>
                        <td class="total-mark">{{ mark.total_internal }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" style="text-align: center; opacity: 0.6;">Academic records not yet available.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="glass-card">
        <h3><i class="fas fa-receipt"></i> Payment Receipts</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Fee Type</th>
                        <th>Amount</th>
                        <th>Date Paid</th>
                        <th>Order ID</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for fee in paid_fees %}
                    <tr>
                        <td>{{ fee.fee_type }}</td>
                        <td>₹ {{ fee.amount }}</td>
                        <td>{{ fee.paid_on|date:"d M Y" }}</td>
                        <td><code style="font-size: 10px; color: var(--gold);">{{ fee.paypal_order_id }}</code></td>
                        <td><span style="color: #4ade80; font-weight: bold;">PAID</span></td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" style="text-align: center; opacity: 0.6;">No transaction history.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<meta name="csrf-token" content="{{ csrf_token }}">

<script>
document.addEventListener("DOMContentLoaded", function () {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    document.querySelectorAll(".pay-btn").forEach(btn => {
        btn.addEventListener("click", function () {
            const apiUrl = this.dataset.feeUrl;
            this.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Loading...';

            fetch(apiUrl, {
                method: "POST",
                credentials: "same-origin",
                headers: {
                    "X-CSRFToken": csrfToken,
                    "Accept": "application/json"
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.approval_url) {
                    window.location.href = data.approval_url;
                } else {
                    alert("Error: " + (data.error || "Unknown error"));
                    this.innerText = 'Pay via PayPal';
                }
            })
            .catch(err => {
                alert("Payment system unreachable.");
                this.innerText = 'Pay via PayPal';
            });
        });
    });
});
</script>

{% endblock %}